<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body { margin: 0; padding: 0; }

      space {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;

        display: flex;
      }

      templates { display: none; }

      sdp {
        word-break: break-all;
        white-space: pre-wrap;
      }

      connection {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
      }

      connection
      sdp,
      connection
      input-area,
      connection
      answer {
        flex: 1 1 auto;

        display: flex;

        justify-content: center;
        align-items: center;

        padding: 1em;
      }

      connection
      input-area {
        background-color: rgba(0, 0, 0, 0.33);
      }

    </style>
    <script>
      function load() {
        function getEl(tagName, el) { return (el || document).getElementsByTagName(tagName)[0]; }

        var space = getEl('space'),
            templates = getEl('templates');

        var ConnectionTemplate = {
          createNew: function() { return getEl('connection', templates).cloneNode(true); }
        };


        startConnection();

        function startConnection() {
          var el = ConnectionTemplate.createNew();

          space.appendChild(el);

          var sdpEl = getEl('sdp', el),
              inputAreaEl = getEl('input-area', el);

          inputAreaEl.oninput = function(event) {
            var content = event.target.textContent;

            var newPC = new RTCPeerConnection(config);

            var i = JSON.parse(atob(content));
            console.log(i);

            if (i.type === 'offer') {

              sdpEl.remove();
              inputAreaEl.remove();

              var answerEl = document.createElement('answer');

              el.appendChild(answerEl);

              newPC
                .setRemoteDescription(i)
                .then(function() {
                  return newPC.createAnswer();
                })
                .then(function(answer) {
                  console.log('answer', answer);
                  var enc = btoa(answer.sdp);

                  setElText(answer, enc);
                })
                .catch(function(error) {
                  console.log('error', error);
                });
            }
            else {

            }
          };

          var googleSTUN = getGoogleSTUN();

          var config = {
            'iceServers': [googleSTUN]
          };

          var pc = new RTCPeerConnection(config);

          pc.onnegotiationneeded = function (event) {
            pc
              .createOffer()
              .then(function(offer) {
                pc.setLocalDescription(offer);

                setSdpElText(btoa(JSON.stringify(offer)));

                selectText(sdpEl);
              })
              .catch(function(error) {
                setSdpElText(JSON.stringify(error));
                selectText(sdpEl);
              });
          };

          pc.onicecandidate = function (event) {
            console.log('icecandidate', event);
            setSdpElText(btoa(JSON.stringify(pc.localDescription)));
            selectText(sdpEl);
          };

          pc.onicecandidateerror = function (event) {};

          pc.onsignalingstatechange = function (event) {};
          pc.oniceconnectionstatechange = function (event) {};
          pc.onicegatheringstatechange = function (event) {};

          pc.onconnectionstatechange = function (event) {
            setElText(el, pc.connectionState);
          };

          function setElText (el, text) { el.innerHTML = text; }

          function setSdpElText(text) { setElText(sdpEl, text); }
          function setAnswerElText(text) { setElText(answerEl, text); }

          function selectText(el) {
            var range = document.createRange();
            range.selectNodeContents(el);
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
          }



          pc.createDataChannel('block');


          function getGoogleSTUN() {
            return {
              urls: [
                'stun:stun1.l.google.com:19302'/*,
                'stun:stun2.l.google.com:19302',
                'stun:stun3.l.google.com:19302',
                'stun:stun4.l.google.com:19302'*/
              ]
            };
          }
        }



      }
    </script>
  </head>
  <body onload="load()">

    <space></space>

    <templates>

      <connection>
        <sdp></sdp>
        <input-area contenteditable="true"></input-area>
      </connection>

    </templates>

  <body>
</html>