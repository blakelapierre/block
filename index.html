<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body { margin: 0; padding: 0; color: #fff; background-color: #000; }

      space {
        position: fixed;
        top: 0; bottom: 0; left: 0; right: 0;

        display: flex;
        max-height: 100%;
        overflow-y: auto;
      }

      templates { display: none; }

      offer, answer {
        flex: 0 0 auto;

        word-break: break-all;
        white-space: pre-wrap;

        padding: 1em;
      }

      connection {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;

        justify-content: center;
        align-items: stretch;
      }

      connection input-area {
        flex: 1 0 auto;

        padding: 1em;

        background-color: rgba(255, 255, 255, 0.33);
        border: solid 1px rgba(255, 255, 255, 0.75);
      }

      data-channel-block-ui {
        flex: 1 1 auto;

        display: flex;

        overflow-y: auto;
      }

      messages {
        width: 100%;

        flex: 0 1 auto;

        flex-direction: column;

        overflow-y: auto;
      }

      message, our-message { display: block; margin: 1em; padding: 1em; border: solid 1px rgba(255, 255, 255, 0.33); }

      our-message {
        text-align: right;
      }

      input-area { min-height: 3em; }

    </style>
    <script>
      function emptyFn() {}
      function b (fn, t) { return function () { return fn.apply(t, arguments); }; }
      function c (t, fn) { return function () { return t[fn].apply(t, arguments); }; }

      // var iframe;
      function encode (text) { return btoa(text); }
      function decode (text) { return atob(text); }
      // space.appendChild((iframe = document.createElement('iframe')));
      // iframe.src =


      function getDevices() {
        console.log('getting devices');
        return new Promise(function (resolve, reject) {
          navigator
            .mediaDevices
              .getUserMedia({'audio': true, 'video': true})
              .then(handleAudioVideoStream)
              .catch(function (error) {

                navigator
                  .mediaDevices
                    .getUserMedia({'audio': true})
                    .then(handleAudioStream)
                    .catch(function (error) {  });

                navigator
                  .mediaDevices
                    .getUserMedia({'video': true})
                    .then(handleVideoStream)
                    .catch(function (error) {  });

              });

          function handleAudioVideoStream (stream) {
            console.log('audiovideo', stream);
          }

          function handleAudioStream (stream) {
            console.log('audio', stream);

          }

          function handleVideoStream (stream) {
            console.log('video', stream);

          }
        });
      }

      getDevices()
        .then(function (devices) {
          console.log('getDevices', devices);
        })
        .catch(function (error) {
          console.log('getDevices error', error);
        });

      // navigator
      //   .mediaDevices
      //     .getUserMedia({'audio': true, 'video': true})
      //     .then(function (stream) {
      //       console.log('stream', stream);
      //     })
      //     .catch(function (error) {
      //       console.log('error', error);
      //     });

      var notify = (function () {
        var permissioned = false;

        return function notify (message) {
          if (!permissioned) return Notification.requestPermission(function (result) {
            if (result === 'granted') {
              permissioned = true;
              n(message);
            }
          });

          n(message);

          function n (m) { return new Notification(m); }
        };
      })();

      var googleSTUN = getGoogleSTUN();

      var config = {
        'iceServers': [googleSTUN,
        {
          'urls': 'turn:68.183.22.27:3478?transport=udp',
          'credential': 'anon',
          'username': 'anon'
        }]
      };

      function getGoogleSTUN() {
        return {
          urls: [
            'stun:stun1.l.google.com:19302' //, 'stun:stun2.l.google.com:19302', 'stun:stun3.l.google.com:19302', 'stun:stun4.l.google.com:19302'
          ]
        };
      }


      function events (obj, handlers) {
        console.log('events -- ff not working');

        if (obj === null || obj === undefined) return console.log('oops, no obj for handlers!');

        var allEvents = Object.keys(Object.getPrototypeOf(obj)).filter(function (key) {
          console.log('*', key );
          return key.indexOf('on') === 0 && key.length > 2;
        });

        return [obj, allEvents.reduce(function (r, key) {
          r[key] = event(obj, key, handlers[key] || emptyFn);
          return r;
        }, {})];
      }

      function event(obj, name, handler) {
        obj[name] = function() {
          console.log('#e', name, arguments);
          handler.apply(obj, arguments);
        };
      }

      function load() {
        var space = getEl('space'),
            templates = getEl('templates');

        var ConnectionTemplate = {
          createNew: function() { return getEl('connection', templates).cloneNode(true); }
        };

        startConnection();

        function getEl(tagName, el) { return (el || document).getElementsByTagName(tagName)[0]; }

        function startConnection() {
          function stringEncodeObject(obj) { return JSON.stringify(obj, value); }
          function stringDecodeObject(obj) { return JSON.parse(obj, value); }

          function value(key, value) { return value; }
          function stingifyEncode(key, value) { return stringEncode(value); }
          function parseDecode(key, value) { return stringDecode(value); }

          function ifType(typeName, fn) { return function (obj) { return typeof obj === typeName ? fn(obj) : obj; }; }

          function stringEncode (obj) { return ifType('string', encode)(obj); }
          function stringDecode (obj) { return ifType('string', decode)(obj); }


          var el = ConnectionTemplate.createNew();

          space.appendChild(el);

          var offerEl = getEl('offer', el),
              inputAreaEl = getEl('input-area', el);

          var channelonopenHandlers = {
            'block': startDataChannelUi,
            'latency': startLatencyChannelUI
          };

          var pc = makePeer(),
              channel = pc.createDataChannel('block'),
              latencyChannel= pc.createDataChannel('latency');


          [channel, latencyChannel].forEach(function (channel) {
            events(channel, {
              'onopen': function (event) { channelonopenHandlers[channel.label](channel); }
            });
          });

          inputAreaEl.addEventListener('input', connectionInputHandler);

          function connectionInputHandler (event) {
            var message = stringDecodeObject(event.target.textContent);

            inputAreaEl.removeEventListener('input', connectionInputHandler);
            inputAreaEl.remove();

            offerEl.remove();
            setElText(inputAreaEl, '');

            var answerEl = document.createElement('answer');
            el.insertBefore(answerEl, el.firstChild);

            var ondatachannelHandlers = {
              'block': function () { answerEl.remove(); }
            };

            processMessage(message);

            function processMessage(message) {

              ({
                'offer': function () { pc = setupConnection(message, updateUI); },
                'answer': function () { pc.setRemoteDescription(message); }
              })[message.type]();


              function updateUI (answer) {
                var enc = stringEncodeObject(answer);

                setElText(answerEl, enc);
                selectText(answerEl);
              }

              function setupConnection(offer, haveAnswerddddddddddddddd) {
                (pc = makePeer())
                  .setRemoteDescription(offer)
                  .then(c(pc, 'createAnswer'))
                  .then(c(pc, 'setLocalDescription'))
                  .then(function() { return haveAnswer(pc.localDescription); })
                  .catch(function(error) {
                    console.log('error', error);
                  });

                events(pc, {
                  'ondatachannel': function(event) {
                    var channel = event.channel;

                    (ondatachannelHandlers[channel.label] || emptyFn)();

                    events(channel, {
                      'onopen': function (event) { channelonopenHandlers[channel.label](channel); }
                    });
                  }
                });

                return pc;
              }
            }
          }

          function makePeer() {
            console.log('making peer');
            var pc; return (
              pc = createNewPeerConnection(
                function (offer) {
                  setOfferElText(stringEncodeObject(pc.localDescription));
                  selectText(offerEl);
                }, function (answer) {

                }, function (error) {
                  console.log('error', error);
                  setOfferElText(JSON.stringify(error));
                  selectText(offerEl);
                }
              )
            );

            function createNewPeerConnection(deliverOffer, receiveAnswer, deliverError) {
              var pc;

              return events(
                pc = new RTCPeerConnection(config), {
                  'onnegotiationneeded': function (event) {
                    pc
                      .createOffer()
                      .then(function (offer) { return pc.setLocalDescription(offer); })
                      .then(function () { return deliverOffer(pc.localDescription); })
                      .catch(deliverError);
                  },

                  'onicecandidate': function (event) { return deliverOffer(pc.localDescription); }
                }
              )[0];
            }
          }

          function startDataChannelUi (channel) {
            var ui = makeDataChannelUI(channel);

            el.appendChild(ui);
            el.appendChild(inputAreaEl);

            inputAreaEl.focus();

            function makeDataChannelUI (channel) {
              var messages = document.createElement('messages'),
                  channelInput = document.createElement('channel-input'),
                  ui = document.createElement('data-channel-' + channel.label + '-ui');

              ui.appendChild(messages);
              ui.appendChild(channelInput);

              inputAreaEl.onkeydown = function (event) {
                if (event.keyCode === 13) return addOurMessage(event.target.textContent), sendInput(event);
              };

              events(channel, {
                'onmessage': function (event) {
                  console.log('message', event);
                  var messageEl = document.createElement('message');

                  messageEl.innerText = event.data;

                  messages.appendChild(messageEl);

                  if (document.hidden) notify(event.data);
                }
              });

              function addOurMessage(text) {
                var messageEl = document.createElement('our-message');

                messageEl.innerText = text;

                messages.appendChild(messageEl);
              }

              function sendInput (event) {
                console.log('sending', event);
                channel.send(event.target.textContent);
                event.target.textContent = '';
              }

              return ui;
            }
          }

          function startLatencyChannelUI (channel) {
            var latencyChannel = channel;

            function ping() {
              console.log('pinging');
              latencyChannel.send(new Date().getTime());
            }

            function pong(message) {
              console.log('pong');

              var parts = message.split(' ');
              var theirTime, diff;
              var ourTime = new Date().getTime();

              if (parts.length > 1) {
                var ourOldTime = parseInt(parts[0], 10);

                theirTime = parseInt(parts[1], 10);

                diff = ourTime - ourOldTime;
              }
              else {
                theirTime = parseInt(parts[0]);

                latencyChannel.send(theirTime + ' ' + ourTime);

                diff = undefined;
              }

              console.log('diff', diff);

              return diff;
            }

            var diffListener;
            function setDiff(diff) {
              if (diffListener) diffListener(diff);
            }

            function getDiff(fn) {
              diffListener = fn;
            }

            events(latencyChannel, {
              'onmessage': function (event) {
                console.log('latency message', event.data);
                var diff = pong(event.data);

                if (diff !== undefined) setDiff(diff);
              }
            });

            ping();

            var ui = makeLatencyUI(latencyChannel, ping, pong, getDiff);

            el.insertBefore(ui, el.firstChild);

            return ui;

            function makeLatencyUI (channel, ping, pong, setDiff) {
              var ui = document.createElement('latency-ui'),
                  button = document.createElement('button'),
                  diffEl = document.createElement('diff');

              button.innerText = 'ping';

              ui.appendChild(button);
              ui.appendChild(diffEl);

              button.addEventListener('click', function (event) {
                ping();
              });

              setDiff(function (diff) {
                diffEl.innerText = diff;
              });

              return ui;
            }
          }

          function setElText (el, text) { el.innerHTML = text; }

          function setOfferElText(text) { setElText(offerEl, text); }
          function setAnswerElText(text) { setElText(answerEl, text); }

          function selectText(el) {
            var range = document.createRange();
            range.selectNodeContents(el);
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
          }
        }
      }
    </script>
  </head>
  <body onload="load()">

    <space></space>

    <templates>

      <connection>
        <offer></offer>
        <input-area contenteditable="true"></input-area>
      </connection>

    </templates>

  <body>
</html>