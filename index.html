<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body { margin: 0; padding: 0; color: #fff; background-color: #000; }

      space {
        position: fixed;
        top: 0; bottom: 0; left: 0; right: 0;

        display: flex;
        max-height: 100%;
        overflow-y: auto;
      }

      offer, answer {
        flex: 0 0 auto;

        word-break: break-all;
        white-space: pre-wrap;

        padding: 1em;
      }

      offer, answer {
        display: flex;

        flex-direction: column;

        align-items: center;
      }

      connection {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;

        justify-content: center;
        align-items: stretch;
      }

      connection input-area {
        flex: 1 0 auto;

        padding: 1em;

        background-color: rgba(255, 255, 255, 0.33);
        border: solid 1px rgba(255, 255, 255, 0.75);
      }

      sound-button { cursor: pointer; }

      data-channel-block-ui {
        flex: 1 1 auto;

        display: flex;

        overflow-y: auto;
      }

      messages {
        width: 100%;

        flex: 0 1 auto;

        flex-direction: column;

        overflow-y: auto;
      }

      message, our-message { display: block; margin: 1em; padding: 1em; border: solid 1px rgba(255, 255, 255, 0.33); }

      our-message {
        text-align: right;
      }

      input-area { min-height: 3em; }

      a {
        color: #fff;
        text-decoration: none;
        font-weight: bold;
        font-size: large;
      }

    </style>
    <script>
      var script = e('script');

      function emptyFn() {}
      function b (fn, t) { return function () { return fn.apply(t, arguments); }; }
      function c (t, fn) { return function () { return t[fn].apply(t, arguments); }; }

      function encode (text) { return btoa(text); }
      function decode (text) { return atob(text); }

      var googleSTUN = getGoogleSTUN();

      var turn = {
        'urls': 'turn:68.183.22.27:3478?transport=udp',
        'credentialType': 'password',
        'credential': 'anon',
        'username': 'anon'
      };

      var config = {
        'iceServers': [googleSTUN, turn]
      };

      function e (name) { return document.createElement(name); }

      function load() {

        setup();

        function setup () {

          var space = e('space');

          append(document.body, [space]);

          startConnection();

          function startConnection() {
            function stringEncodeObject(obj) { return JSON.stringify(obj, value); }
            function stringDecodeObject(obj) { return JSON.parse(obj, value); }

            function value(key, value) { return value; }

            function ifType(typeName, fn) { return function (obj) { return typeof obj === typeName ? fn(obj) : obj; }; }

            function stringEncode (obj) { return ifType('string', encode)(obj); }
            function stringDecode (obj) { return ifType('string', decode)(obj); }

            var el = e('connection'),
                offerEl = e('offer'),
                offerTextEl = e('offer-text'),
                offerEmailLink = e('a'),
                answerEmailLink = e('a'),
                offerCopyLink = e('a'),
                answerCopyLink = e('a'),
                inputAreaEl = e('input-area');

            inputAreaEl.contentEditable = true;
            inputAreaEl.addEventListener('input', connectionInputHandler);

            emailLink(offerEmailLink);
            emailLink(answerEmailLink);

            copyLink(offerCopyLink);
            copyLink(answerCopyLink);

            append(space, [
              append(el, [
                append(offerEl, [
                  offerTextEl,
                  offerEmailLink,
                  offerCopyLink
                ]),
                inputAreaEl
              ])
            ]);


            // append(offerEl, [offerTextEl, offerEmailLink, offerCopyLink ]);

            // append(el, [offerEl, inputAreaEl]);

            // append(space, [el]);

            function emailLink (e) { link(e, 'Send as Email'); }
            function copyLink (e)  { link(e, 'Copy As Link'); }

            function link (e, text, target, href) {
              e.innerText = text;
              e.target = target || '__blank';
              e.href = href || '';
            }

            var channelonopenHandlers = {
              'block': startDataChannelUi,
              'latency': startLatencyChannelUI
            };

            var pc = makePeer(),
                channel = pc.createDataChannel('block'),
                latencyChannel= pc.createDataChannel('latency');

            [channel, latencyChannel].forEach(function (channel) {
              events(channel, {
                'onopen': function (event) { channelonopenHandlers[channel.label](channel); }
              });
            });

            go(window.location.hash);

            window.addEventListener('hashchange', function (event) { go(window.location.hash); });

            function go (hash) {
              if (hash.length > 1) {
                window.location.hash = '';

                connectionInputHandler({
                  target: {
                    textContent: atob(hash.substring(1))
                  }
                });
              }
            }

            function connectionInputHandler (event) {
              var message = stringDecodeObject(event.target.textContent);

              inputAreaEl.removeEventListener('input', connectionInputHandler);
              inputAreaEl.remove();

              offerEl.remove();
              setElText(inputAreaEl, '');

              var answerEl = e('answer'),
                  answerTextEl = e('answer-text');

              append(answerEl, [answerTextEl, answerEmailLink, answerCopyLink]);

              el.insertBefore(answerEl, el.firstChild);

              var ondatachannelHandlers = {
                'block': function () { answerEl.remove(); }
              };

              events(pc, {
                'oniceconnectionstatechange': function (event) {
                  console.log('connection state', pc.iceConnectionState);
                  if (pc.iceConnectionState === 'connected') {
                    answerEl.remove();
                  }
                }
              });

              pc.addEventListener('icecandidate', function (event) { updateUI(pc.localDescription); })

              processMessage(message);

              function updateUI (answer) {
                var enc = stringEncodeObject(answer);

                var link = encodeURI(window.location.origin + window.location.pathname + '#' + btoa(enc)),
                    body = 'Connect to me at: ' + link,
                    subject = 'Connect to me';

                answerEmailLink.href = encodeURI('mailto:?subject=' + subject + '&body=' + body);
                answerCopyLink.href = link;

                setElText(answerTextEl, enc);
                selectText(answerTextEl);
              }

              function processMessage(message) {

                ({
                  'offer': function () { pc = setupConnection(message, updateUI); },
                  'answer': function () {
                    pc.setRemoteDescription(message)
                      .catch(function (error) {
                        console.log('error!', error);
                      });
                  }
                })[message.type]();

                function setupConnection(offer, haveAnswer) {
                  (pc = makePeer())
                    .setRemoteDescription(offer)
                    .then(c(pc, 'createAnswer'))
                    .then(c(pc, 'setLocalDescription'))
                    .then(function() { return haveAnswer(pc.localDescription); })
                    .catch(function(error) {
                      console.log('error', error);
                    });

                  events(pc, {
                    'ondatachannel': function(event) {
                      var channel = event.channel;

                      (ondatachannelHandlers[channel.label] || emptyFn)();

                      events(channel, {
                        'onopen': function (event) { channelonopenHandlers[channel.label](channel); }
                      });
                    },

                    'oniceconnectionstatechange': function(event) {
                      if (pc.iceConnectionState === 'connected') {
                        answerEl.remove();
                      }
                    },

                    'onicecandidate': function (event) { updateUI(pc.localDescription); }
                  });

                  return pc;
                }
              }
            }

            function makePeer() {
              var pc; return (
                pc = createNewPeerConnection(
                  function (offer) {
                    var enc = stringEncodeObject(pc.localDescription);

                    var link = encodeURI(window.location.origin + window.location.pathname + '#' + btoa(enc)),
                        body = 'Connect to me at: ' + link,
                        subject = 'Connect to me';

                    offerEmailLink.href = encodeURI('mailto:?subject=' + subject + '&body=' + body);
                    offerCopyLink.href = link;

                    setOfferElText(enc);
                    selectText(offerTextEl);
                  },
                  function (answer) { },
                  function (error) {
                    console.log('error', error);
                    setOfferElText(JSON.stringify(error));
                    selectText(offerTextEl);
                  }
                )
              );

              function createNewPeerConnection(deliverOffer, receiveAnswer, deliverError) {
                var pc;

                return events(
                  pc = new RTCPeerConnection(config), {
                    'onnegotiationneeded': function (event) {
                      pc
                        .createOffer()
                        .then(setLocalDescription)
                        .then(function () { return deliverOffer(pc.localDescription); })
                        .catch(deliverError);
                    },

                    'onicecandidate': function (event) { return deliverOffer(pc.localDescription); }
                  }
                )[0];

                function setLocalDescription(offer) { return pc.setLocalDescription(offer); }
              }
            }

            function startDataChannelUi (channel) {
              var ui = makeDataChannelUI(channel);

              append(el, [ui, inputAreaEl]);

              inputAreaEl.focus();

              function makeDataChannelUI (channel) {
                var messages = e('messages'),
                    channelInput = e('channel-input'),
                    ui = e('data-channel-' + channel.label + '-ui');

                append(ui, [messages, channelInput]);

                inputAreaEl.onkeydown = function (event) {
                  if (event.keyCode === 13) return addOurMessage(event.target.textContent), sendInput(event);
                };

                events(channel, {
                  'onmessage': function (event) {
                    var messageEl = e('message');

                    messageEl.innerText = event.data;

                    messages.prepend(messageEl);

                    if (document.hidden) notify(event.data);
                  }
                });

                function addOurMessage(text) {
                  var messageEl = e('our-message');

                  messageEl.innerText = text;

                  messages.prepend(messageEl);
                }

                function sendInput (event) {
                  channel.send(event.target.textContent);
                  event.target.textContent = '';
                }

                return ui;
              }
            }

            function startLatencyChannelUI (channel) {
              var latencyChannel = channel;

              function ping() {
                latencyChannel.send(new Date().getTime());
              }

              function pong(message) {
                var parts = message.split(' ');
                var theirTime, diff;
                var ourTime = new Date().getTime();

                if (parts.length > 1) {
                  var ourOldTime = parseInt(parts[0], 10);

                  theirTime = parseInt(parts[1], 10);

                  diff = ourTime - ourOldTime;
                }
                else {
                  theirTime = parseInt(parts[0]);

                  latencyChannel.send(theirTime + ' ' + ourTime);

                  diff = undefined;
                }

                console.log('diff', diff);

                return diff;
              }

              var diffListener;
              function setDiff(diff) { if (diffListener) diffListener(diff); }

              function getDiff(fn) { diffListener = fn; }

              events(latencyChannel, {
                'onmessage': function (event) {
                  var diff = pong(event.data);

                  if (diff !== undefined) setDiff(diff);
                }
              });

              ping();

              var ui = makeLatencyUI(latencyChannel, ping, pong, getDiff);

              el.insertBefore(ui, el.firstChild);

              return ui;

              function makeLatencyUI (channel, ping, pong, setDiff) {
                var ui = e('latency-ui'),
                    button = e('button'),
                    diffEl = e('diff');

                button.innerText = 'ping';

                append(ui, [button, diffEl]);

                button.addEventListener('click', function (event) { ping(); });

                setDiff(function (diff) { diffEl.innerText = diff; });

                return ui;
              }
            }

            function setElText (el, text) { el.innerHTML = text; }

            function setOfferElText(text) { setElText(offerTextEl, text); }
            function setAnswerElText(text) { setElText(answerTextEl, text); }

            function selectText(el) {
              if (!el.isConnected) return;

              var range = document.createRange();
              range.selectNodeContents(el);
              var sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            }
          }
        }
      }

      function getGoogleSTUN() {
        return {
          urls: [
            'stun:stun1.l.google.com:19302' //, 'stun:stun2.l.google.com:19302', 'stun:stun3.l.google.com:19302', 'stun:stun4.l.google.com:19302'
          ]
        };
      }


      function events (obj, handlers) {
        console.log('events -- ff not working');

        if (obj === null || obj === undefined) return console.log('oops, no obj for handlers!');

        var allEvents = Object.keys(Object.getPrototypeOf(obj)).filter(function (key) {
          console.log('*', key );
          return key.indexOf('on') === 0 && key.length > 2;
        });

        return [obj, allEvents.reduce(function (r, key) {
          r[key] = event(obj, key, handlers[key] || emptyFn);
          return r;
        }, {})];
      }

      function event(obj, name, handler) {
        obj[name] = function() {
          console.log('#e', name, arguments);
          handler.apply(obj, arguments);
        };
      }

      function append (p, c) {
        c.forEach(function (e) { p.appendChild(e); });
        return p;
      }
    </script>
  </head>
  <body onload="load()"></body>
</html>