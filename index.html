<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body { margin: 0; padding: 0; }

      space { position: fixed; top: 0; bottom: 0; left: 0; right: 0; display: flex; }

      templates { display: none; }

      offer, answer {
        word-break: break-all;
        white-space: pre-wrap;
      }

      connection {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
      }

      connection
      offer,
      connection
      input-area,
      connection
      answer {
        flex: 1 1 auto;

        display: flex;

        justify-content: center;
        align-items: center;

        padding: 1em;
      }

      connection
      input-area {
        background-color: rgba(0, 0, 0, 0.33);
      }

    </style>
    <script>
      var googleSTUN = getGoogleSTUN();

      var config = {
        'iceServers': [googleSTUN]
      };

      function getGoogleSTUN() {
        return {
          urls: [
            'stun:stun1.l.google.com:19302'/*,
            'stun:stun2.l.google.com:19302',
            'stun:stun3.l.google.com:19302',
            'stun:stun4.l.google.com:19302'*/
          ]
        };
      }

      function emptyFn() {}

      function event(obj, name, handler) {
        obj[name] = function() {
          console.log(name, arguments);
          handler.call(arguments);
        };
      }

      function events (obj, handlers) {
        console.log('events -- ff not working');

        console.log(obj, Object.keys(obj));

        var allEvents = Object.keys(obj.__proto__).filter(function (key) {
          console.log('*', key );
          return key.indexOf('on') === 0 && key.length > 2;
        });

        return allEvents.reduce(function (r, key) {
          console.log(key);
          r[key] = event(obj, key, handlers[key] || emptyFn);
          return r;
        }, {});

        // return Object.keys(handlers).reduce(function (r, key) {
        //   r[key] = event(obj, key, handlers[key]);
        //   return r;
        // }, {});
      }

      function load() {
        function getEl(tagName, el) { return (el || document).getElementsByTagName(tagName)[0]; }

        var space = getEl('space'),
            templates = getEl('templates'),
            iframe;

        // space.appendChild((iframe = document.createElement('iframe')));

        // iframe.src =

        var ConnectionTemplate = {
          createNew: function() { return getEl('connection', templates).cloneNode(true); }
        };


        startConnection();

        function startConnection() {

          function createNewPeerConnection(receiveOffer, receiveAnswer, receiveError) {

            var pc = new RTCPeerConnection(config);

            events(pc, {
              'onsignalingstatechange': function (event) { console.log(pc.signalingState); },
              'onnegotiationneeded': function (event) {
                console.log('onneg');
                pc
                  .createOffer()
                  .then(function(offer) {
                    pc.setLocalDescription(offer);
                    receiveOffer(offer);
                  })
                  .catch(receiveError);
              },

              'onicecandidate': function (event) { return receiveOffer(pc.localDescription); }
            });

            return pc;
          }

          var pc = createNewPeerConnection(function (offer) {
            setOfferElText(JSON.stringify(pc.localDescription != null ? pc.localDescription.sdp : undefined));
            selectText(offerEl);
          }, function (answer) {

          }, function (error) {
            console.log('error', error);
            setOfferElText(JSON.stringify(error));
            selectText(offerEl);
          });

          var el = ConnectionTemplate.createNew();

          space.appendChild(el);

          var offerEl = getEl('offer', el),
              inputAreaEl = getEl('input-area', el);


          inputAreaEl.oninput = function(event) {
            var content = event.target.textContent;

            offerEl.remove();
            setElText(inputAreaEl, '');

            var i = JSON.parse(content);
            console.log('i', i);

            var offer = {type: 'offer', sdp: i};

            var answerEl = document.createElement('answer');
            el.insertBefore(answerEl, el.firstChild);

            if (pc.signalingState === 'have-local-offer') {
              var newPC = createNewPeerConnection(
                function (offer) {
                  // setOfferElText(btoa(JSON.stringify(offer)));
                  setOfferElText(JSON.stringify(pc.localDescription));

                  selectText(offerEl);
                },
                function (answer) {

                },
                function (error) {
                  console.log('error', error);
                  setOfferElText(JSON.stringify(error));
                  selectText(offerEl);
                });

              events(newPC, {
                'ondatachannel': function(event) {
                  var channel = event.channel;

                  console.log(channel);
                }
              });

              // newPC.ondatachannel = function(event) {
              //   var channel = event.channel;

              //   console.log(channel);
              // };

              newPC
                .setRemoteDescription(offer)
                .then(function() { return newPC.createAnswer(); })
                .then(function(answer) {
                  console.log('answer', answer, pc);
                    // pc.remoteDescription = answer.sdp;
                  // var enc = btoa(JSON.stringify(pc.remoteDescription));
                  var enc = JSON.stringify(answer.sdp);

                  setElText(answerEl, enc);
                  selectText(answerEl);
                })
                .catch(function(error) {
                  console.log('error', error);
                });
            }
            else {

              console.log('sdp', i);
              var answer = {type: 'pranswer', sdp: i};

              pc
                .setRemoteDescription(answer)
                .then(function() {
                  console.log('remote description set', pc.remoteDescription);
                  setElText(answerEl, JSON.stringify(pc.remoteDescription));
                  selectText(answerEl);
                })
                .catch(function (error) {
                  console.log('answer error', error);
                });

              inputAreaEl.remove();

              console.dir(pc, i);
            }

            // if (i.type === 'offer') {
            //   var newPC = createNewPeerConnection(
            //     function (offer) {
            //       setOfferElText(btoa(JSON.stringify(offer)));

            //       selectText(offerEl);
            //     },
            //     function (answer) {

            //     },
            //     function (error) {
            //       console.log('error', error);
            //       setOfferElText(JSON.stringify(error));
            //       selectText(offerEl);
            //     });

            //   newPC.ondatachannel = function(event) {
            //     var channel = event.channel;

            //     console.log(channel);
            //   };

            //   newPC
            //     .setRemoteDescription(i)
            //     .then(function() { return newPC.createAnswer(); })
            //     .then(function(answer) {
            //       console.log('answer', answer, pc);
            //         // pc.remoteDescription = answer.sdp;
            //       // var enc = btoa(JSON.stringify(pc.remoteDescription));
            //       var enc = btoa(JSON.stringify(answer.sdp));

            //       setElText(answerEl, enc);
            //       selectText(answerEl);
            //     })
            //     .catch(function(error) {
            //       console.log('error', error);
            //     });
            // }
            // else if (i.type === 'answer') {
            //   console.log('sdp', i);

            //   pc
            //     .setRemoteDescription(i)
            //     .then(function() {
            //       console.log('remote description set', pc.remoteDescription);
            //       setElText(answerEl, btoa(JSON.stringify(pc.remoteDescription)));
            //       selectText(answerEl);
            //     })
            //     .catch(function (error) {
            //       console.log('answer error', error);
            //     });

            //   inputAreaEl.remove();

            //   console.dir(pc, i);
            // }
          };

          function setElText (el, text) { el.innerHTML = text; }

          function setOfferElText(text) { setElText(offerEl, text); }
          function setAnswerElText(text) { setElText(answerEl, text); }

          function selectText(el) {
            var range = document.createRange();
            range.selectNodeContents(el);
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
          }

          pc.createDataChannel('block');
        }
      }
    </script>
  </head>
  <body onload="load()">

    <space></space>

    <templates>

      <connection>
        <offer></offer>
        <input-area contenteditable="true"></input-area>
      </connection>

    </templates>

  <body>
</html>