<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body { margin: 0; padding: 0; }

      space { position: fixed; top: 0; bottom: 0; left: 0; right: 0; display: flex; }

      templates { display: none; }

      offer, answer {
        word-break: break-all;
        white-space: pre-wrap;
      }

      connection {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
      }

      connection
      offer,
      connection
      input-area,
      connection
      answer {
        flex: 1 1 auto;

        display: flex;

        justify-content: center;
        align-items: center;

        padding: 1em;
      }

      connection
      input-area {
        background-color: rgba(0, 0, 0, 0.33);
      }

    </style>
    <script>
      var googleSTUN = getGoogleSTUN();

      var config = {
        'iceServers': [googleSTUN]
      };

      function getGoogleSTUN() {
        return {
          urls: [
            'stun:stun1.l.google.com:19302'/*,
            'stun:stun2.l.google.com:19302',
            'stun:stun3.l.google.com:19302',
            'stun:stun4.l.google.com:19302'*/
          ]
        };
      }

      function emptyFn() {}

      function event(obj, name, handler) {
        obj[name] = function() {
          console.log('#e', name, arguments);
          handler.call(arguments);
        };
      }

      function events (obj, handlers) {
        console.log('events -- ff not working');

        var allEvents = Object.keys(obj.__proto__).filter(function (key) {
          console.log('*', key );
          return key.indexOf('on') === 0 && key.length > 2;
        });

        return [obj, allEvents.reduce(function (r, key) {
          r[key] = event(obj, key, handlers[key] || emptyFn);
          return r;
        }, {})];

      }

      // var iframe;
      // space.appendChild((iframe = document.createElement('iframe')));
      // iframe.src =

      function load() {
        function getEl(tagName, el) { return (el || document).getElementsByTagName(tagName)[0]; }

        function createNewPeerConnection(deliverOffer, receiveAnswer, receiveError) {
          var pc;

          return events(
            pc = new RTCPeerConnection(config), {
              'onsignalingstatechange': function (event) { console.log('signaling state change', pc.signalingState); },

              'onnegotiationneeded': function (event) {
                pc
                  .createOffer()
                  .then(function (offer) { return pc.setLocalDescription(offer), offer; })
                  .then(function (offer) { return deliverOffer(pc.localDescription); })
                  .catch(receiveError);
              },

              'onicecandidate': function (event) { return deliverOffer(pc.localDescription); }
            }
          )[0];
        }

        var space = getEl('space'),
            templates = getEl('templates');

        var ConnectionTemplate = {
          createNew: function() { return getEl('connection', templates).cloneNode(true); }
        };

        startConnection();

        function startConnection() {

          function makePeer() {
            console.log('making peer');
            var pc; return (
              pc = createNewPeerConnection(
                function (offer) {
                  setOfferElText(stringEncodeObject(pc.localDescription));
                  selectText(offerEl);
                }, function (answer) {

                }, function (error) {
                  console.log('error', error);
                  setOfferElText(JSON.stringify(error));
                  selectText(offerEl);
                }
              )
            );
          }

          function stringEncodeObject(obj) { return JSON.stringify(obj, value); }
          function stringDecodeObject(obj) { return JSON.parse(obj, value); }

          function value(key, value) { return value; }
          function stingifyEncode(key, value) { return stringEncode(value); }
          function parseDecode(key, value) { return stringDecode(value); }

          function ifType(typeName, fn) { return function (obj) { return typeof obj === typeName ? fn(obj) : obj; }; }

          function stringEncode (obj) { return ifType('string', encode)(obj); }
          function stringDecode (obj) { return ifType('string', decode)(obj); }

          function encode (text) { return btoa(text); }
          function decode (text) { return atob(text); }

          var el = ConnectionTemplate.createNew();

          space.appendChild(el);

          var offerEl = getEl('offer', el),
              inputAreaEl = getEl('input-area', el);

          var pc = makePeer();

          var channel = pc.createDataChannel('block');

          events(channel, {
            'onopen': function(event) {
              console.log('!', event);
            }
          });

          inputAreaEl.oninput = function(event) {
            var content = event.target.textContent;

            offerEl.remove();
            setElText(inputAreaEl, '');

            var i = stringDecodeObject(content);
            console.log('i', i);

            var answerEl = document.createElement('answer');
            el.insertBefore(answerEl, el.firstChild);

            if (i.type === 'offer') {
              var offer = i;

              (pc = makePeer())
                .setRemoteDescription(offer)
                .then(function() { return pc.createAnswer(); })
                .then(function(answer) { return pc.setLocalDescription(answer), answer; })
                .then(function(answer) {
                  console.log('answer', answer, pc);
                  var enc = stringEncodeObject(answer);

                  setElText(answerEl, enc);
                  selectText(answerEl);
                })
                .catch(function(error) {
                  console.log('error', error);
                });

              events(pc, {
                'onsignalingstatechange': function (event) {
                  console.log('signaling state change', pc.signalingState);
                },

                'onnegotiationneeded': function (event) {
                  console.log('@@@@@');
                },

                'ondatachannel': function(event) {
                  var channel = event.channel;

                  console.log('chan!!!!!', channel);
                }
              });
            }
            else if (i.type === 'answer') {
              var answer = i;
              pc
                .setRemoteDescription(answer)
                .then(function() {
                  console.log('remote description set', pc.remoteDescription);
                  setElText(answerEl, 'good');
                  selectText(answerEl);
                })
                .catch(function (error) {
                  console.log('answer error', error);
                });

              inputAreaEl.remove();
            }
          };

          function setElText (el, text) { el.innerHTML = text; }

          function setOfferElText(text) { setElText(offerEl, text); }
          function setAnswerElText(text) { setElText(answerEl, text); }

          function selectText(el) {
            var range = document.createRange();
            range.selectNodeContents(el);
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
          }
        }
      }
    </script>
  </head>
  <body onload="load()">

    <space></space>

    <templates>

      <connection>
        <offer></offer>
        <input-area contenteditable="true"></input-area>
      </connection>

    </templates>

  <body>
</html>