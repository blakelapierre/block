<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body { margin: 0; padding: 0; }

      space {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;

        display: flex;
      }

      templates { display: none; }

      sdp { word-break: break-all; }

      connection {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
      }

      connection
      sdp,
      connection
      input-area {
        flex: 1 1 auto;

        display: flex;

        justify-content: center;
        align-items: center;

        padding: 1em;
      }

      connection
      input-area {
        background-color: rgba(0, 0, 0, 0.33);
      }

    </style>
    <script>
      function load() {
        function getEl(tagName, el) { return (el || document).getElementsByTagName(tagName)[0]; }

        var space = getEl('space'),
            templates = getEl('templates');


        startConnection();

        function startConnection() {
          var connectionT = getEl('connection', templates);
          function makeConnectionNode() { return connectionT.cloneNode(true); }

          var el = makeConnectionNode();
          space.appendChild(el);

          var sdpEl = getEl('sdp', el),
              inputAreaEl = getEl('input-area', el);

          inputAreaEl.oninput = function(event) {
            var content = event.target.textContent;
            pc
              .setRemoteDescription({type: 'offer', sdp: content})
              .then(pc.createAnswer)
              .then(function(answer) {
                console.log('answer', answer);
              })
              .catch(function(error) {
                console.log('error', error);
              });
          };

          var googleSTUN = getGoogleSTUN();

          var config = {
            'iceServers': [googleSTUN]
          };

          var pc = new RTCPeerConnection(config);

          pc.onnegotiationneeded = function (event) {
            pc
              .createOffer()
              .then(function(offer) {
                // setSdpElText(JSON.stringify(offer));
                console.log(offer);
                setSdpElText(btoa(offer.sdp));
                setSdpElText(offer.sdp);
                pc.setLocalDescription(offer);
              })
              .catch(function(error) {
                setSdpElText(JSON.stringify(error));
              });
          };

          pc.onicecandidate = function (event) {
            console.log('icecandidate', event);
          };

          function setSdpElText(text) { sdpEl.innerHTML = text; }



          pc.createDataChannel('block');


          function getGoogleSTUN() {
            return {
              urls: [
                'stun:stun1.l.google.com:19302'/*,
                'stun:stun2.l.google.com:19302',
                'stun:stun3.l.google.com:19302',
                'stun:stun4.l.google.com:19302'*/
              ]
            };
          }
        }



      }
    </script>
  </head>
  <body onload="load()">

    <space></space>

    <templates>

      <connection>
        <sdp></sdp>
        <input-area contenteditable="true"></input-area>
      </connection>

    </templates>

  <body>
</html>