<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body { margin: 0; padding: 0; }

      space {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;

        display: flex;
      }

      templates { display: none; }

      offer, answer {
        word-break: break-all;
        white-space: pre-wrap;
      }

      connection {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
      }

      connection
      offer,
      connection
      input-area,
      connection
      answer {
        flex: 1 1 auto;

        display: flex;

        justify-content: center;
        align-items: center;

        padding: 1em;
      }

      connection
      input-area {
        background-color: rgba(0, 0, 0, 0.33);
      }

    </style>
    <script>
      function load() {
        function getEl(tagName, el) { return (el || document).getElementsByTagName(tagName)[0]; }

        var space = getEl('space'),
            templates = getEl('templates');

        var ConnectionTemplate = {
          createNew: function() { return getEl('connection', templates).cloneNode(true); }
        };


        startConnection();

        function startConnection() {
          var el = ConnectionTemplate.createNew();

          space.appendChild(el);

          var offerEl = getEl('offer', el),
              inputAreaEl = getEl('input-area', el);


          inputAreaEl.oninput = function(event) {
            var content = event.target.textContent;

            offerEl.remove();
            setElText(inputAreaEl, '');

            var i = JSON.parse(atob(content));
            console.log(i);

            var answerEl = document.createElement('answer');
            el.insertBefore(answerEl, el.firstChild);

            if (i.type === 'offer') {
              var newPC = new RTCPeerConnection(config);

              newPC.onnegotiationneeded = function (event) {
                newPC
                  .createOffer()
                  .then(function(offer) {
                    newPC.setLocalDescription(offer);

                    setOfferElText(btoa(JSON.stringify(offer)));

                    selectText(offerEl);
                  })
                  .catch(function(error) {
                    console.log('error', error);
                    setOfferElText(JSON.stringify(error));
                    selectText(offerEl);
                  });
              };

              newPC.onicecandidate = function (event) {
                console.log('icecandidate2', event);
              };
              newPC.onicecandidateerror = function (event) {
                console.log('icecandidateerror2', event);
              };

              newPC.onsignalingstatechange = function (event) {
                console.log('signalingstatechange2', event);
                // setElText(el, pc.signalingState);
              };
              newPC.oniceconnectionstatechange = function (event) {
                console.log('iceconnectionstatechange2', event);
                // setElText(el, pc.iceConnectionState);
              };
              newPC.onicegatheringstatechange = function (event) {
                console.log('icegatheringstatechange2', event);
                // setElText(el, pc.iceGatheringState);
              };

              newPC.onconnectionstatechange = function (event) {
                // setElText(el, newPC.connectionState);
              };

              newPC.ondatachannel = function(event) {
                var channel = event.channel;

                console.log(channel);
              };

              newPC
                .setRemoteDescription(i)
                .then(function() { return newPC.createAnswer(); })
                .then(function(answer) {
                  console.log('answer', answer, pc);
                  var enc = btoa(JSON.stringify(pc.remoteDescription));

                  setElText(answerEl, enc);
                  selectText(answerEl);
                })
                .catch(function(error) {
                  console.log('error', error);
                });
            }
            else if (i.type === 'answer') {
              console.log('sdp', i.sdp);

              pc
                .setRemoteDescription(i)
                .then(function() {
                  console.log('remote description set', pc.remoteDescription);
                  setElText(answerEl, btoa(JSON.stringify(pc.remoteDescription)));
                  selectText(answerEl);
                })
                .catch(function (error) {
                  console.log('answer error', error);
                });

              inputAreaEl.remove();

              console.dir(pc, i);
            }
          };

          var googleSTUN = getGoogleSTUN();

          var config = {
            'iceServers': [googleSTUN]
          };

          var pc = new RTCPeerConnection(config);

          pc.onnegotiationneeded = function (event) {
            pc
              .createOffer()
              .then(function(offer) {
                pc.setLocalDescription(offer);

                setOfferElText(btoa(JSON.stringify(offer)));
                selectText(offerEl);
              })
              .catch(function(error) {
                console.log('error', error);

                setOfferElText(JSON.stringify(error));
                selectText(offerEl);
              });
          };

          pc.onicecandidate = function (event) {
            console.log('icecandidate', event);
            setOfferElText(btoa(JSON.stringify(pc.localDescription)));
            selectText(offerEl);
          };

          pc.onicecandidateerror = function (event) {
            console.log('onicecandidateerror', event);
          };

          pc.onsignalingstatechange = function (event) {
            console.log('onsignalingstatechange', event);
            // setElText(el, pc.signalingState);
          };
          pc.oniceconnectionstatechange = function (event) {
            console.log('oniceconnectionstatechange', event);
            // setElText(el, pc.iceConnectionState);
          };
          pc.onicegatheringstatechange = function (event) {
            console.log('onicegatheringstatechange', event);
            // setElText(el, pc.iceGatheringState);
          };

          pc.onconnectionstatechange = function (event) {
            // setElText(el, pc.connectionState);
          };

          function setElText (el, text) { el.innerHTML = text; }

          function setOfferElText(text) { setElText(offerEl, text); }
          function setAnswerElText(text) { setElText(answerEl, text); }

          function selectText(el) {
            var range = document.createRange();
            range.selectNodeContents(el);
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
          }



          pc.createDataChannel('block');


          function getGoogleSTUN() {
            return {
              urls: [
                'stun:stun1.l.google.com:19302'/*,
                'stun:stun2.l.google.com:19302',
                'stun:stun3.l.google.com:19302',
                'stun:stun4.l.google.com:19302'*/
              ]
            };
          }
        }



      }
    </script>
  </head>
  <body onload="load()">

    <space></space>

    <templates>

      <connection>
        <offer></offer>
        <input-area contenteditable="true"></input-area>
      </connection>

    </templates>

  <body>
</html>